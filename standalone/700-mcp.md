# 7. Model Context Protocol (MCP) Integration

This lab demonstrates how to integrate the NVIDIA NeMo Agent toolkit with [Model Context Protocol (MCP)](https://github.com/modelcontextprotocol/modelcontextprotocol) servers. You'll learn to use remote tools through MCP and publish Agent toolkit functions as MCP services.

You can run the simple calculator workflow using Remote MCP tools. In this case, the workflow acts as a MCP client and connects to the MCP server running on the specified URL. Details are provided in the [MCP Client Guide](../../../docs/source/workflows/mcp/mcp-client.md).

NeMo Agent toolkit enables workflows to use MCP tools as functions. The library handles the MCP server connection, tool discovery, and function registration. This allows the workflow to use MCP tools as regular functions.

## 7.1 Prerequisites

Install the packages required to run the workflow and MCP server.

```bash
cd ~/nemo-agent-toolkit/
uv pip install -e examples/MCP/simple_calculator_mcp
```

## 7.2 Check the MCP tools

The tools for the `simple_calculator` are defined in the `register.py` file:

```bash
cd ~/nemo-agent-toolkit/
cat examples/getting_started/simple_calculator/src/nat_simple_calculator/register.py 
```

You should have the following output:

```python
# SPDX-FileCopyrightText: Copyright (c) 2024-2025, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import logging

from nat.builder.builder import Builder
from nat.builder.function_info import FunctionInfo
from nat.cli.register_workflow import register_function
from nat.data_models.function import FunctionBaseConfig

logger = logging.getLogger(__name__)

# pylint: disable=unused-argument


def extract_numbers(text: str) -> list[str]:
    """
    Extract numerical values (including floats) from text.

    Args:
        text: Input text containing numbers

    Returns:
        List of number strings found in the text
    """
    import re
    return re.findall(r"\d+(?:\.\d+)?", text)


def validate_number_count(numbers: list[str], expected_count: int, action: str) -> str | None:
    if len(numbers) < expected_count:
        return f"Provide at least {expected_count} numbers to {action}."
    if len(numbers) > expected_count:
        return f"This tool only supports {action} between {expected_count} numbers."
    return None


class InequalityToolConfig(FunctionBaseConfig, name="calculator_inequality"):
    pass


@register_function(config_type=InequalityToolConfig)
async def calculator_inequality(tool_config: InequalityToolConfig, builder: Builder):

    async def _calculator_inequality(text: str) -> str:
        numbers = extract_numbers(text)
        validation_error = validate_number_count(numbers, expected_count=2, action="compare")
        if validation_error:
            return validation_error
        a = float(numbers[0])
        b = float(numbers[1])
        if a > b:
            return f"First number {a} is greater than the second number {b}"
        if a < b:
            return f"First number {a} is less than the second number {b}"

        return f"First number {a} is equal to the second number {b}"

    # Create a Generic NAT tool that can be used with any supported LLM framework
    yield FunctionInfo.from_fn(
        _calculator_inequality,
        description=("This is a mathematical tool used to perform an inequality comparison between two numbers. "
                     "It takes two numbers as an input and determines if one is greater or are equal."))


class MultiplyToolConfig(FunctionBaseConfig, name="calculator_multiply"):
    pass


@register_function(config_type=MultiplyToolConfig)
async def calculator_multiply(config: MultiplyToolConfig, builder: Builder):

    async def _calculator_multiply(text: str) -> str:
        numbers = extract_numbers(text)
        validation_error = validate_number_count(numbers, expected_count=2, action="multiply")
        if validation_error:
            return validation_error
        a = int(numbers[0])
        b = int(numbers[1])

        return f"The product of {a} * {b} is {a * b}"

    # Create a Generic NAT tool that can be used with any supported LLM framework
    yield FunctionInfo.from_fn(
        _calculator_multiply,
        description=("This is a mathematical tool used to multiply two numbers together. "
                     "It takes 2 numbers as an input and computes their numeric product as the output."))


class DivisionToolConfig(FunctionBaseConfig, name="calculator_divide"):
    pass


@register_function(config_type=DivisionToolConfig)
async def calculator_divide(config: DivisionToolConfig, builder: Builder):

    async def _calculator_divide(text: str) -> str:
        numbers = extract_numbers(text)
        validation_error = validate_number_count(numbers, expected_count=2, action="divide")
        if validation_error:
            return validation_error
        a = float(numbers[0])
        b = float(numbers[1])

        return f"The result of {a} / {b} is {a / b}"

    # Create a Generic NAT tool that can be used with any supported LLM framework
    yield FunctionInfo.from_fn(
        _calculator_divide,
        description=("This is a mathematical tool used to divide one number by another. "
                     "It takes 2 numbers as an input and computes their numeric quotient as the output."))


class SubtractToolConfig(FunctionBaseConfig, name="calculator_subtract"):
    pass


@register_function(config_type=SubtractToolConfig)
async def calculator_subtract(config: SubtractToolConfig, builder: Builder):

    async def _calculator_subtract(text: str) -> str:
        numbers = extract_numbers(text)
        validation_error = validate_number_count(numbers, expected_count=2, action="subtract")
        if validation_error:
            return validation_error
        a = int(numbers[0])
        b = int(numbers[1])

        return f"The result of {a} - {b} is {a - b}"

    # Create a Generic NAT tool that can be used with any supported LLM framework
    yield FunctionInfo.from_fn(
        _calculator_subtract,
        description=("This is a mathematical tool used to subtract one number from another. "
                     "It takes 2 numbers as an input and computes their numeric difference as the output."))
```

## 7.3 Launch the MCP server

Start the remote MCP server with:

```bash
nat mcp serve --config_file examples/getting_started/simple_calculator/configs/config.yml
```

This starts an MCP server on port 9901 with endpoint `/mcp` and uses `streamable-http` transport. See the [MCP Server](../../../docs/source/workflows/mcp/mcp-server.md) documentation for more information.

You should have the following output:

```console
2026-01-11 01:46:30 - INFO     - nat.cli.commands.start:192 - Starting NAT from config file: 'examples/getting_started/simple_calculator/configs/config.yml'
/home/ubuntu/nemo-agent-toolkit/.venv/lib/python3.13/site-packages/langchain_nvidia_ai_endpoints/_common.py:198: UserWarning: An API key is required for the hosted NIM. This will become an error in the future.
  warnings.warn(
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:285 - Registering function calculator_multiply with MCP
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:289 - Function calculator_multiply has input schema: <class 'nat.builder.function_info.InputArgsSchema'>
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:285 - Registering function calculator_inequality with MCP
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:289 - Function calculator_inequality has input schema: <class 'nat.builder.function_info.InputArgsSchema'>
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:285 - Registering function current_datetime with MCP
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:289 - Function current_datetime has input schema: <class 'nat.builder.function_info.InputArgsSchema'>
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:285 - Registering function calculator_divide with MCP
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:289 - Function calculator_divide has input schema: <class 'nat.builder.function_info.InputArgsSchema'>
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:285 - Registering function calculator_subtract with MCP
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:289 - Function calculator_subtract has input schema: <class 'nat.builder.function_info.InputArgsSchema'>
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:285 - Registering function react_agent with MCP
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:289 - Function react_agent has input schema: <class 'nat.data_models.api_server.ChatRequestOrMessage'>
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:295 - Function react_agent is a Workflow
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.tool_converter:98 - Function react_agent uses ChatRequest - creating simplified interface
2026-01-11 01:46:30 - INFO     - nat.front_ends.mcp.mcp_front_end_plugin:113 - Starting MCP server with streamable-http endpoint at /mcp/
INFO:     Started server process [6414]
INFO:     Waiting for application startup.
2026-01-11 01:46:30 - INFO     - mcp.server.streamable_http_manager:115 - StreamableHTTP session manager started
INFO:     Application startup complete.
INFO:     Uvicorn running on http://localhost:9901 (Press CTRL+C to quit)
```

## 7.4 Check the Workflow configuration

Open a new terminal to check the workflow configuration.

<a href="#"  onclick="showLabPanel(1,2); return false;" style="font-size:1.25em; background:#007cba; color:#fff; padding:10px 20px; border-radius:6px; text-decoration:none;">
  Open New Terminal
</a>

The workflow configuration is defined with the `config.yml` file.

This configuration creates two function groups:

- `mcp_time`: Connects to a local MCP server using stdio transport to get current date and time
- `mcp_math`: Connects to a remote MCP server using streamable-http transport to access calculator tools

Check the configuration file

```bash
cd ~/nemo-agent-toolkit/
cat examples/MCP/simple_calculator_mcp/configs/config-mcp-client-azure.yml
```

You should have the following output:

```yaml
# SPDX-FileCopyrightText: Copyright (c) 2024-2025, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This config file shows how to use the MCP server to get the current date and time.
# Here the workflow acts as a MCP client and connects to the MCP server running
# on the specified URL. streamable-http is the recommended transport for HTTP-based
# connections, but sse is also supported for backwards compatibility.

# This config file shows -
# 1. how to use a local MCP server to get the current date and time using stdio transport.
# 2. how to access a remote MCP server using streamable-http transport for math operations.
#
# As the mcp_server_time is running locally ensure that the package "mcp_server_time" is installed
# on your local machine. For example, if you are using pip, you can install it with:
# uv pip install mcp-server-time

function_groups:
  mcp_time:
    _type: mcp_client
    server:
      transport: stdio
      command: "python"
      args: ["-m", "mcp_server_time", "--local-timezone=America/Los_Angeles"]
    tool_overrides:
      # Optionally override the tool name and description from the MCP server
      get_current_time:
        alias: get_current_time_mcp_tool
        description: "Returns the current date and time"

  mcp_math:
    _type: mcp_client
    server:
      transport: streamable-http
      url: "http://localhost:9901/mcp"
    include:
      - calculator_multiply
      - calculator_inequality
      - calculator_divide
      - calculator_subtract

llms:
  azure_llm:
    _type: azure_openai
    azure_endpoint: ${AZURE_OPENAI_ENDPOINT}
    azure_deployment: ${AZURE_OPENAI_DEPLOYMENT}
    api_key: ${AZURE_OPENAI_API_KEY}
    api_version: ${AZURE_OPENAI_API_VERSION}
    temperature: 0.0

workflow:
  _type: react_agent
  tool_names:
    - mcp_time
    - mcp_math
  llm_name: azure_llm
  verbose: true
  retry_parsing_errors: true
  max_retries: 3
```

## 7.5 Run the Workflow

Activate the virtual environment and run the workflow:

```bash
cd ~/nemo-agent-toolkit/
source .venv/bin/activate
nat run --config_file=examples/MCP/simple_calculator_mcp/configs/config-mcp-client-azure.yml --input "Is the product of 2 * 4 greater than the current hour of the day?"
```

You should have the following output:

```console
2026-01-11 01:43:29 - INFO     - nat.cli.commands.start:192 - Starting NAT from config file: 'examples/MCP/simple_calculator_mcp/configs/config-mcp-client-azure.yml'
2026-01-11 01:43:29 - INFO     - nat.plugins.mcp.client_impl:523 - Configured to use MCP server at stdio:python
2026-01-11 01:43:30 - WARNING  - nat.builder.function_info:455 - Using provided input_schema for multi-argument function
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:567 - Adding tool get_current_time_mcp_tool to group
2026-01-11 01:43:30 - WARNING  - nat.builder.function_info:455 - Using provided input_schema for multi-argument function
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:567 - Adding tool convert_time to group
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:523 - Configured to use MCP server at streamable-http:http://localhost:9901/mcp
2026-01-11 01:43:30 - INFO     - mcp.client.streamable_http:181 - Received session ID: 4abcbefe9b104e56a7f455191b7d2b67
2026-01-11 01:43:30 - INFO     - mcp.client.streamable_http:193 - Negotiated protocol version: 2025-11-25
2026-01-11 01:43:30 - WARNING  - nat.builder.function_info:455 - Using provided input_schema for multi-argument function
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:567 - Adding tool calculator_multiply to group
2026-01-11 01:43:30 - WARNING  - nat.builder.function_info:455 - Using provided input_schema for multi-argument function
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:567 - Adding tool calculator_inequality to group
2026-01-11 01:43:30 - WARNING  - nat.builder.function_info:455 - Using provided input_schema for multi-argument function
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:567 - Adding tool current_datetime to group
2026-01-11 01:43:30 - WARNING  - nat.builder.function_info:455 - Using provided input_schema for multi-argument function
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:567 - Adding tool calculator_divide to group
2026-01-11 01:43:30 - WARNING  - nat.builder.function_info:455 - Using provided input_schema for multi-argument function
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:567 - Adding tool calculator_subtract to group
2026-01-11 01:43:30 - WARNING  - nat.builder.function_info:455 - Using provided input_schema for multi-argument function
2026-01-11 01:43:30 - INFO     - nat.plugins.mcp.client_impl:567 - Adding tool react_agent to group

Configuration Summary:
--------------------
Workflow Type: react_agent
Number of Functions: 0
Number of Function Groups: 2
Number of LLMs: 1
Number of Embedders: 0
Number of Memory: 0
Number of Object Stores: 0
Number of Retrievers: 0
Number of TTC Strategies: 0
Number of Authentication Providers: 0

2026-01-11 01:43:33 - INFO     - nat.agent.react_agent.agent:175 - 
------------------------------
[AGENT]
Agent input: Is the product of 2 * 4 greater than the current hour of the day?
Agent's thoughts: 
Question: Is the product of 2 * 4 greater than the current hour of the day?  
Thought: I need to calculate the product of 2 * 4 and compare it to the current hour of the day. First, I will calculate the product.  
Action: mcp_math.calculator_multiply  
Action Input: {"text": "2 * 4"}
------------------------------
2026-01-11 01:43:33 - INFO     - nat.plugins.mcp.client_base:637 - Calling tool calculator_multiply
2026-01-11 01:43:33 - INFO     - nat.agent.base:221 - 
------------------------------
[AGENT]
Calling tools: mcp_math.calculator_multiply
Tool's input: {'text': '2 * 4'}
Tool's response: 
The product of 2 * 4 is 8
------------------------------
2026-01-11 01:43:34 - INFO     - nat.agent.react_agent.agent:199 - 
------------------------------
[AGENT]
Agent input: Is the product of 2 * 4 greater than the current hour of the day?
Agent's thoughts: 
Thought: Now that I know the product is 8, I need to find the current hour of the day to compare it with 8.  
Action: mcp_time.get_current_time_mcp_tool  
Action Input: {"timezone": "America/Los_Angeles"}
------------------------------
2026-01-11 01:43:34 - INFO     - nat.plugins.mcp.client_base:637 - Calling tool get_current_time
2026-01-11 01:43:34 - INFO     - nat.agent.base:221 - 
------------------------------
[AGENT]
Calling tools: mcp_time.get_current_time_mcp_tool
Tool's input: {'timezone': 'America/Los_Angeles'}
Tool's response: 
{
  "timezone": "America/Los_Angeles",
  "datetime": "2026-01-10T17:43:34-08:00",
  "day_of_week": "Saturday",
  "is_dst": false
}
------------------------------
2026-01-11 01:43:37 - INFO     - nat.agent.react_agent.agent:199 - 
------------------------------
[AGENT]
Agent input: Is the product of 2 * 4 greater than the current hour of the day?
Agent's thoughts: 
Thought: The current hour of the day in "America/Los_Angeles" timezone is 17 (5 PM). I will now compare 8 with 17 to determine if 8 is greater.

Action: mcp_math.calculator_inequality  
Action Input: {"text": "8 > 17"}
------------------------------
2026-01-11 01:43:37 - INFO     - nat.plugins.mcp.client_base:637 - Calling tool calculator_inequality
2026-01-11 01:43:37 - INFO     - nat.agent.base:221 - 
------------------------------
[AGENT]
Calling tools: mcp_math.calculator_inequality
Tool's input: {'text': '8 > 17'}
Tool's response: 
First number 8.0 is less than the second number 17.0
------------------------------
2026-01-11 01:43:38 - INFO     - nat.agent.react_agent.agent:199 - 
------------------------------
[AGENT]
Agent input: Is the product of 2 * 4 greater than the current hour of the day?
Agent's thoughts: 
Thought: I now know the final answer. The product of 2 * 4 (which is 8) is not greater than the current hour of the day (17).

Final Answer: No, the product of 2 * 4 is not greater than the current hour of the day.
------------------------------
2026-01-11 01:43:38 - INFO     - nat.front_ends.console.console_front_end_plugin:102 - --------------------------------------------------
Workflow Result:
['No, the product of 2 * 4 is not greater than the current hour of the day.']
--------------------------------------------------
```
